<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Modifica Mazzo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-image: url('sfondo.jpg');
      background-size: cover;
      background-attachment: fixed;
    }
    header {
      background: white;
      padding: 1em;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    header button {
      background: none;
      border: none;
      cursor: pointer;
    }
    header img {
      height: 50px;
    }
    main {
      padding: 2em;
      background-color: rgba(255, 255, 255, 0.8);
      max-width: 1200px;
      margin: auto;
    }
    select, input[type="text"] {
      margin-right: 1em;
      padding: 0.5em;
    }
    .carte-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 1em;
    }
    .carte-container img {
      width: 80px;
      border: 1px solid #aaa;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .carte-container img:hover {
      transform: scale(1.2);
    }
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 1.5em;
      border: 2px solid black;
      z-index: 100;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
      border-radius: 10px;
    }
    .popup .close-btn {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 20px;
      cursor: pointer;
      font-weight: bold;
    }
    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 99;
    }
    #totaleCarte {
      margin-top: 1em;
      font-weight: bold;
    }
    @keyframes tremolio {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(1deg); }
      50% { transform: rotate(0deg); }
      75% { transform: rotate(-1deg); }
    }
    
    .tremolante {
      animation: tremolio 0.3s infinite;
      cursor: pointer;
    }
    
    #popupCartaIngrandita {
      display: none;
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      max-width: 90%;
      max-height: 90%;
      z-index: 200;
      cursor: pointer;
    }
    
    #popupCartaIngrandita img {
      width: 100%;
      height: auto;
      border-radius: 10px;
    }


	.subheader-bar{
	  position: fixed;
	  top: 60px;              /* sotto l’header */
	  left: 0;
	  right: 0;
	  z-index: 999;
	  padding: 10px;
	  pointer-events: none;
	}
	
	.btn-back{
	  pointer-events: auto;
	  width: 42px;
	  height: 42px;
	  border: none;
	  border-radius: 10px;
	  background: rgba(255,255,255,0.92);
	  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
	  cursor: pointer;
	
	  font-size: 32px;
	  font-weight: bold;
	  line-height: 1;
	  color: #111;
	
	  display: flex;
	  align-items: center;
	  justify-content: center;
	}


  </style>
</head>
<body>
  <header>
    <button onclick="window.location.href='home.html'"><img src="logo.jpg" alt="Home"></button>
  </header>

	<div class="subheader-bar">
	  <button class="btn-back" onclick="goBack()" aria-label="Indietro">
	    ‹
	  </button>
	</div>

	
  <main>
    <h1 id="titolo"></h1>

    <label for="filtroTipo">Filtro Tipo:</label>
    <select id="filtroTipo">
      <option value="">Tutti</option>
      <option value="PERSONAGGIO">PERSONAGGIO</option>
      <option value="LUOGO">LUOGO</option>
      <option value="OGGETTO">OGGETTO</option>
      <option value="AZIONE">AZIONE</option>
      <option value="AZIONE (CANZONE)">AZIONE (CANZONE)</option>
    </select>

    <label for="filtroPietra">Filtro Pietra:</label>
    <select id="filtroPietra">
      <option value="">Tutti</option>
    </select>

    <label for="filtroCosto">Filtro Costo:</label>
    <select id="filtroCosto">
      <option value="">Tutti</option>
    </select>

    <button onclick="apriPopupAggiunta()">➕ Aggiungi carta</button>

    <button id="btnEliminaCarte" onclick="toggleModalitaElimina()">❌ Elimina Carte</button>


    <div class="carte-container" id="contenitoreCarte"></div>
    <div id="totaleCarte"></div>

    <section id="statisticheMazzo" style="margin-top: 40px; padding: 20px; background: rgba(255,255,255,0.9); border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2); max-width: 1200px; margin-left: auto; margin-right: auto;">
      <h2>Statistiche del Mazzo</h2>
      <div style="display: flex; gap: 40px; flex-wrap: wrap; justify-content: center;">
        <div>
          <h3>Distribuzione per Tipo</h3>
          <canvas id="graficoTipo" width="400" height="300"></canvas>
        </div>
        <div>
          <h3>Distribuzione per Costo</h3>
          <canvas id="graficoCosto" width="400" height="300"></canvas>
        </div>
        <div>
          <h3>Distribuzione Inchiostrabile</h3>
          <canvas id="chartInchiostrabile" width="400" height="300"></canvas>
        </div>
      </div>
    </section>

	<section id="exportMazzo" style="margin-top: 30px; padding: 20px; background: rgba(255,255,255,0.9); border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.2); max-width: 1200px; margin-left: auto; margin-right: auto;">
	  <h2>Esporta mazzo come Database JSON</h2>
	
	  <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center;">
	    <label>
	      Nome file (.json):
	      <input id="nomeFileJson" type="text" placeholder="starterdeckstarlight.json" style="margin-left:8px; padding:0.5em;">
	    </label>
	
	    <label>
	      Titolo mazzo:
	      <input id="titoloJson" type="text" placeholder="Starter Deck Starlight" style="margin-left:8px; padding:0.5em;">
	    </label>
	
	    <label>
	      Autore:
	      <input id="autoreJson" type="text" placeholder="Luigi" style="margin-left:8px; padding:0.5em;">
	    </label>
	  </div>
	
	  <div style="margin-top:12px;">
	    <label>
	      Descrizione:
	      <input id="descrizioneJson" type="text" placeholder="Breve descrizione del mazzo..." style="width:min(900px, 100%); padding:0.5em;">
	    </label>
	  </div>
	
	  <div style="margin-top:14px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
	    <button id="btnCreaDbMazzo" style="padding: 0.6em 1.2em; font-size: 1.05em; cursor: pointer; background-color: #2d7ef7; border: none; border-radius: 6px; color: white;">
	      Crea database del mazzo
	    </button>
	    <span id="exportInfo" style="color:#444;"></span>

		<button id="btnCopiaTestoMazzo"
		  style="padding: 0.6em 1.2em; font-size: 1.05em; cursor: pointer; background-color: #555; border: none; border-radius: 6px; color: white;">
		  Copia il mazzo in formato testo
		</button>
		
		<span id="toastCopiaMazzo"
		  style="display:none; margin-left:10px; padding:6px 10px; background:#2e7d32; color:white; border-radius:8px; font-weight:700;">
		  Mazzo copiato!
		</span>
	  </div>
	
	  <div style="margin-top:10px; color:#666; font-size:0.92em;">
	    Questo pulsante crea un file JSON scaricabile. Poi puoi caricarlo nella cartella <strong>mazzi/</strong> del repository GitHub.
	  </div>
	</section>
  </main>

  <div class="overlay" id="overlay"></div>
  <div class="popup" id="popup">
    <span class="close-btn" onclick="chiudiPopup()">&times;</span>
    <h3>Aggiungi carta al mazzo</h3>
    <input type="text" id="inputRicerca" placeholder="Cerca per nome...">
    <div id="risultatiRicerca"></div>
  </div>  

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
	let __cardsPromise = null;
	
	async function loadAllCards() {
	  if (__cardsPromise) return __cardsPromise;
	
	  __cardsPromise = (async () => {
	    try {
	      const manifestRes = await fetch("cards/manifest.json");
	      if (!manifestRes.ok) throw new Error("manifest non trovato");
	      const manifest = await manifestRes.json();
	
	      const lists = await Promise.all(
	        (manifest.sets || []).map(async (s) => {
	          const r = await fetch(s.file);
	          if (!r.ok) throw new Error(`Errore fetch set: ${s.file} (${r.status})`);
	          const arr = await r.json();
	          return Array.isArray(arr) ? arr : [];
	        })
	      );
	
	      // Unisce tutti i set in un unico array
	      return lists.flat();
	    } catch (e) {
	      // fallback compatibilità: prova il vecchio cards.json
	      const r = await fetch("cards.json");
	      if (!r.ok) throw e;
	      const data = await r.json();
	      return Array.isArray(data) ? data : [];
	    }
	  })();
	
	  return __cardsPromise;
	}
	  
    const urlParams = new URLSearchParams(window.location.search);
    const nomeMazzo = urlParams.get('mazzo');

	  let modalitaElimina = false;
	  let cardsDatabase = [];
	  let cardsById = {};
	  let mazzo = JSON.parse(localStorage.getItem(`mazzo_${nomeMazzo}`)) || {};
	
	loadAllCards()
		.then(data => {
			cardsDatabase = data;
			cardsById = Object.fromEntries(cardsDatabase.map(c => [String(c.ID), c]));
		
			document.getElementById('inputRicerca').oninput = () => {
		      const val = document.getElementById('inputRicerca').value.toLowerCase();
		      const risultati = cardsDatabase.filter(c => c['NOME CARTA'].toLowerCase().includes(val));
		      const div = document.getElementById('risultatiRicerca');
		      div.innerHTML = '';
		      risultati.forEach(carta => {
		        const btn = document.createElement('button');
		        btn.textContent = `${carta['NOME CARTA']} (${carta['COSTO']})`;
		        btn.onclick = () => aggiungiCarta(carta['ID']);
		        div.appendChild(btn);
		      });
		    };
		
		    aggiornaFiltri();
		    mostraCarte();
		})
		.catch(err => alert("Errore caricamento carte: " + err.message));

	
	  function aggiornaFiltri() {
	    const pietraSet = new Set();
	    const costoSet = new Set();
	
	    for (const id in mazzo) {
	      const carta = cardsDatabase.find(c => String(c['ID']) === String(id));
	      if (!carta) continue;
	      pietraSet.add(carta['PIETRA']);
	      costoSet.add(carta['COSTO']);
	    }
	
	    for (let p of [...pietraSet].sort()) {
	      const op = document.createElement('option');
	      op.value = p;
	      op.textContent = p;
	      document.getElementById('filtroPietra').appendChild(op);
	    }
	
	    for (let c of [...costoSet].sort((a,b)=>a-b)) {
	      const op = document.createElement('option');
	      op.value = c;
	      op.textContent = c;
	      document.getElementById('filtroCosto').appendChild(op);
	    }
	  }
	
	  document.getElementById('filtroTipo').onchange = mostraCarte;
	  document.getElementById('filtroPietra').onchange = mostraCarte;
	  document.getElementById('filtroCosto').onchange = mostraCarte;
	
	  function mostraCarte() {
	    const tipo = document.getElementById('filtroTipo').value;
	    const pietra = document.getElementById('filtroPietra').value;
	    const costo = document.getElementById('filtroCosto').value;
	
	    const container = document.getElementById('contenitoreCarte');
	    container.innerHTML = '';
	
	    let totaleCarte = 0;
	
	    const carteOrdinate = Object.keys(mazzo)
	      .map(id => {
	        const carta = cardsDatabase.find(c => String(c['ID']) === String(id));
	        return carta ? { carta, id } : null;
	      })
	      .filter(e => e !== null)
	      .sort((a, b) => a.carta['COSTO'] - b.carta['COSTO']);

      console.log('mazzo', mazzo);
      console.log('cardsDatabase', cardsDatabase);
      console.log('carte ordinate:', carteOrdinate);
      
	    for (const { carta, id } of carteOrdinate) {
	      if (tipo && carta['TIPO'] !== tipo) continue;
	      if (pietra && carta['PIETRA'] !== pietra) continue;
	      if (costo && carta['COSTO'].toString() !== costo) continue;
	
	      const quantita = mazzo[id];
	      totaleCarte += quantita;
	
	      for (let i = 0; i < quantita; i++) {
	        const img = document.createElement('img');
	        img.src = `img/${id}.jpg`;
	        img.alt = carta['NOME CARTA'];
	
	        if (modalitaElimina) {
	          img.onclick = () => {
	            rimuoviCarta(id);
	            mostraCarte();
	            aggiornaTremolio();
	          };
	        } else {
	          img.onclick = () => {
	            apriPopupCartaIngrandita(img.src);
	          };
	        }
	
	        container.appendChild(img);
	      }
	    }
	
      const contatore = document.getElementById('totaleCarte');
      const titolo = document.getElementById('titolo');
      contatore.textContent = `Carte totali: ${totaleCarte} (min 50, max 70)`;
      
      if (totaleCarte < 50 || totaleCarte > 70) {
        contatore.style.color = 'crimson';
        contatore.title = '⚠️ Il mazzo deve contenere tra 50 e 70 carte';
        titolo.innerHTML = `${nomeMazzo} ⚠️`;
      } else {
        contatore.style.color = '';
        contatore.title = '';
        titolo.textContent = nomeMazzo;
      }

	    aggiornaTremolio();
      aggiornaGrafici();
	    }
	
	  function rimuoviCarta(id) {
	    if (mazzo[id] > 1) {
	      mazzo[id]--;
	    } else {
	      delete mazzo[id];
	    }
	    localStorage.setItem(`mazzo_${nomeMazzo}`, JSON.stringify(mazzo));
	  }
	
	  function toggleModalitaElimina() {
	    modalitaElimina = !modalitaElimina;
	    mostraCarte();
	    aggiornaTremolio();
	    const btn = document.getElementById('btnEliminaCarte');
	    btn.textContent = modalitaElimina ? 'Esci da Modalità Elimina' : 'Elimina Carte';
	  }
	
	  function aggiornaTremolio() {
	    const immagini = document.querySelectorAll('.carte-container img');
	    immagini.forEach(img => {
	      if (modalitaElimina) {
	        img.classList.add('tremolante');
	      } else {
	        img.classList.remove('tremolante');
	      }
	    });
	  }
	
	  function apriPopupCartaIngrandita(src) {
	    let popup = document.getElementById('popupCarta');
	    if (!popup) {
	      popup = document.createElement('div');
	      popup.id = 'popupCarta';
	      popup.style.position = 'fixed';
	      popup.style.top = '50%';
	      popup.style.left = '50%';
	      popup.style.transform = 'translate(-50%, -50%)';
	      popup.style.background = 'transparent';
	      popup.style.zIndex = '10000';
	      popup.style.cursor = 'pointer';
	
	      const img = document.createElement('img');
	      img.style.maxWidth = '90vw';
	      img.style.maxHeight = '80vh';
	      img.style.borderRadius = '10px';
	      popup.appendChild(img);
	
	      popup.onclick = () => {
	        document.body.removeChild(popup);
	      };
	
	      document.body.appendChild(popup);
	    }
	    popup.querySelector('img').src = src;
    }
    function aggiungiCarta(id) {
      const Totale = Object.values(mazzo).reduce((a, b) => a + b, 0);
      const carta = cardsDatabase.find(c => c["ID"] === id);
      const max = (carta && carta["RARITA'"].toUpperCase() === 'PROMO') ? 1 : 3;
    
      if ((mazzo[id] || 0) >= max) {
        alert(`Puoi avere al massimo ${max} copie di questa carta.`);
        return;
      }
      if (Totale >= 70) {
        alert('Il mazzo ha già 70 carte.');
        return;
      }
    
      mazzo[id] = (mazzo[id] || 0) + 1;
      localStorage.setItem(`mazzo_${nomeMazzo}`, JSON.stringify(mazzo));
      mostraCarte();
    }
    
    function apriPopupAggiunta() {
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('popup').style.display = 'block';
    }
    
    function chiudiPopup() {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('popup').style.display = 'none';
      document.getElementById('inputRicerca').value = '';
      document.getElementById('risultatiRicerca').innerHTML = '';
    }
    let graficoTipoInstance = null;
    let graficoCostoInstance = null;
    
    function aggiornaGrafici() {
      const tipoCount = {};
      const costoCount = {};
      const inchiostrabileCount = {};
    
      for (const id in mazzo) {
        const carta = cardsDatabase.find(c => String(c['ID']) === String(id));
        if (!carta) continue;
    
        // Conta per Tipo
        const tipo = carta['TIPO'];
        tipoCount[tipo] = (tipoCount[tipo] || 0) + mazzo[id];
    
        // Conta per Costo
        const costo = carta['COSTO'];
        costoCount[costo] = (costoCount[costo] || 0) + mazzo[id];

        // Conteggio INCHIOSTRABILE
        const valore = carta['INCHIOSTRABILE'] || 'Sconosciuto';
        inchiostrabileCount[valore] = (inchiostrabileCount[valore] || 0) + mazzo[id];
      }
    
      const tipi = Object.keys(tipoCount);
      const quantitaTipo = tipi.map(t => tipoCount[t]);
      const costi = Object.keys(costoCount).sort((a,b) => a - b);
      const quantitaCosto = costi.map(c => costoCount[c]);
      const labelsInchiostrabile = Object.keys(inchiostrabileCount);
      const dataInchiostrabile = Object.values(inchiostrabileCount);
      
    
      // Colori generici per il grafico a torta
      const coloriTipo = tipi.map((_, i) => `hsl(${i * 60 % 360}, 70%, 60%)`);
      const colorsInchiostrabile = labelsInchiostrabile.map(() => `hsl(${Math.random()*360}, 70%, 60%)`);
    
      // Grafico a torta per Tipo
      const ctxTipo = document.getElementById('graficoTipo').getContext('2d');
      if (graficoTipoInstance) graficoTipoInstance.destroy();
      graficoTipoInstance = new Chart(ctxTipo, {
        type: 'pie',
        data: {
          labels: tipi,
          datasets: [{
            data: quantitaTipo,
            backgroundColor: coloriTipo,
            borderColor: '#fff',
            borderWidth: 2,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right' }
          }
        }
      });
    
      // Grafico a barre per Costo
      const ctxCosto = document.getElementById('graficoCosto').getContext('2d');
      if (graficoCostoInstance) graficoCostoInstance.destroy();
      graficoCostoInstance = new Chart(ctxCosto, {
        type: 'bar',
        data: {
          labels: costi,
          datasets: [{
            label: 'Numero carte',
            data: quantitaCosto,
            backgroundColor: 'rgba(54, 162, 235, 0.7)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1,
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, stepSize: 1, ticks: { precision: 0 } },
            x: { title: { display: true, text: 'Costo' } }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
          
        if(window.graficoInchiostrabile) {
          window.graficoInchiostrabile.destroy();
        }        
        const ctxInchiostrabile = document.getElementById('chartInchiostrabile').getContext('2d');
        window.graficoInchiostrabile = new Chart(ctxInchiostrabile, {
            type: 'pie',
            data: {
              labels: labelsInchiostrabile,
              datasets: [{
                data: dataInchiostrabile,
                backgroundColor: colorsInchiostrabile,
              }]
          },
            options: {
              responsive: true,
              plugins: {
                legend: { position: 'right' },
                title: { display: true, text: 'Distribuzione INCHIOSTRABILE nel mazzo' }
              }
          }
      });
    }
	function normalizzaNomeFile(nome) {
	  let n = (nome || "").trim();
	
	  // se vuoto, metto un default
	  if (!n) n = "mazzo.json";
	
	  // aggiungo estensione se manca
	  if (!n.toLowerCase().endsWith(".json")) n += ".json";
	
	  // evita path strani, tieni solo nome file base
	  n = n.split("/").pop().split("\\").pop();
	
	  return n;
	}
	
	function scaricaTestoComeFile(nomeFile, testo, mime = "application/json") {
	  const blob = new Blob([testo], { type: mime });
	  const url = URL.createObjectURL(blob);
	
	  const a = document.createElement("a");
	  a.href = url;
	  a.download = nomeFile;
	  document.body.appendChild(a);
	  a.click();
	  a.remove();
	
	  URL.revokeObjectURL(url);
	}
	
	function costruisciJsonMazzo() {
	  // mazzo è già nel tuo script: oggetto tipo { "1": 2, "4": 3, ... }
	  // lo esportiamo ESATTAMENTE come serve per albodoro.html:
	  // { titolo, autore, descrizione, carte: { "1":2, ... } }
	  const titolo = document.getElementById("titoloJson").value.trim() || nomeMazzo || "Mazzo";
	  const autore = document.getElementById("autoreJson").value.trim();
	  const descrizione = document.getElementById("descrizioneJson").value.trim();
	
	  // opzionale: ordina le chiavi numericamente (solo estetica del file)
	  const carteOrdinate = {};
	  Object.keys(mazzo)
	    .sort((a, b) => Number(a) - Number(b))
	    .forEach(k => { carteOrdinate[String(k)] = Number(mazzo[k]) || 0; });
	
	  return {
	    titolo,
	    autore,
	    descrizione,
	    carte: carteOrdinate
	  };
	}
	
	// Hook sul pulsante
	document.getElementById("btnCreaDbMazzo").onclick = () => {
	  const nomeFileInput = document.getElementById("nomeFileJson").value;
	  const nomeFile = normalizzaNomeFile(nomeFileInput);
	
	  const data = costruisciJsonMazzo();
	
	  // Controllo minimo: mazzo vuoto?
	  const totale = Object.values(data.carte).reduce((s, v) => s + (Number(v) || 0), 0);
	  if (totale === 0) {
	    alert("Il mazzo è vuoto: aggiungi almeno una carta prima di esportare.");
	    return;
	  }
	
	  const testo = JSON.stringify(data, null, 2);
	  scaricaTestoComeFile(nomeFile, testo);
	
	  const info = document.getElementById("exportInfo");
	  info.textContent = `✅ Scaricato: ${nomeFile} (totale carte: ${totale})`;
	};

	function mostraToastCopia() {
	  const toast = document.getElementById("toastCopiaMazzo");
	  if (!toast) return;
	
	  toast.style.display = "inline-block";
	  toast.style.opacity = "1";
	
	  // sparisce da solo
	  clearTimeout(window.__toastTimer);
	  window.__toastTimer = setTimeout(() => {
	    toast.style.opacity = "0";
	    // dopo la dissolvenza lo nascondo
	    setTimeout(() => { toast.style.display = "none"; toast.style.opacity = "1"; }, 250);
	  }, 2000);
	}
	
	function costruisciTestoMazzo() {
	  const titolo = document.getElementById("titoloJson").value.trim() || nomeMazzo || "Mazzo";
	  const autore = document.getElementById("autoreJson").value.trim();
	  const descrizione = document.getElementById("descrizioneJson").value.trim();
	
	  // lista items dal mazzo: {id, qty, costo, nome}
	  const items = Object.keys(mazzo || {})
	    .map(id => {
	      const qty = Number(mazzo[id]) || 0;
	      if (qty <= 0) return null;
	
	      const carta = cardsById[String(id)];
	      const nome = carta?.["NOME CARTA"] || "NOME CARTA NON TROVATO";
	      const costo = Number(carta?.["COSTO"]) || 999;
	
	      return { id: String(id), qty, costo, nome };
	    })
	    .filter(Boolean)
	    .sort((a, b) => a.costo - b.costo || a.nome.localeCompare(b.nome, "it"));
	
	  const totale = items.reduce((s, it) => s + it.qty, 0);
	
	  const out = [];
	  out.push(`TITOLO: ${titolo}`);
	  if (autore) out.push(`AUTORE: ${autore}`);
	  if (descrizione) out.push(`DESCRIZIONE: ${descrizione}`);
	  out.push(`TOTALE CARTE: ${totale}`);
	  out.push("");
	  out.push("LISTA CARTE:");
	  out.push(...(items.length ? items.map(it => `${it.qty}x ${it.nome}`) : ["(Mazzo vuoto)"]));
	
	  return out.join("\n");
	}
	
	async function copiaNegliAppunti(testo) {
	  // metodo moderno
	  if (navigator.clipboard && window.isSecureContext) {
	    await navigator.clipboard.writeText(testo);
	    return;
	  }
	
	  // fallback (vecchio ma funziona spesso)
	  const ta = document.createElement("textarea");
	  ta.value = testo;
	  ta.style.position = "fixed";
	  ta.style.left = "-9999px";
	  document.body.appendChild(ta);
	  ta.focus();
	  ta.select();
	  document.execCommand("copy");
	  ta.remove();
	}
	
	// Hook bottone
	document.getElementById("btnCopiaTestoMazzo").onclick = async () => {
	  try {
	    const testo = costruisciTestoMazzo();
	    const totale = Object.values(mazzo || {}).reduce((s, v) => s + (Number(v) || 0), 0);
	
	    if (totale === 0) {
	      alert("Il mazzo è vuoto: aggiungi almeno una carta prima di copiare.");
	      return;
	    }
	
	    await copiaNegliAppunti(testo);
	    mostraToastCopia();
	  } catch (err) {
	    alert("Errore durante la copia: " + err.message);
	  }
	};
  </script>

  <script>
	function goBack() {
	  if (window.history.length > 1) {
	    window.history.back();
	  } else {
	    window.location.href = 'home.html';
	  }
	}
  </script>
</body>
</html>
