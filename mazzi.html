<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>I tuoi Mazzi - Vita</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2em;
      background: url('sfondo.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #222;
    }
    header {
      text-align: center;
      margin-bottom: 1em;
    }
    header button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 0;
    }
    header button img {
      height: 60px;
    }
    h1 {
      margin-bottom: 1em;
    }
    #listaMazzi {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .mazzo-item {
      background: rgba(255 255 255 / 0.85);
      border-radius: 8px;
      padding: 1em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 0 5px #aaa;
    }
    .mazzo-info {
      flex: 1;
    }
    .mazzo-info strong {
      font-size: 1.2em;
    }
    .mazzo-cards {
      margin-top: 0.5em;
      font-size: 0.9em;
      color: #444;
    }
    .mazzo-buttons button {
      margin-left: 0.5em;
      padding: 0.4em 0.8em;
      font-size: 1em;
      cursor: pointer;
    }

    .action-bar {
      margin-top: 1.5em;
      display: flex;
      gap: 12px;
      align-items: center;   /* ðŸ”´ QUESTO Ãˆ IL PUNTO CHIAVE */
      flex-wrap: wrap;
    }
    
    .action-btn {
      min-width: 220px;
      height: 44px;
      padding: 0;
      font-size: 1.1em;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      color: white;
    
      display: flex;         /* non inline-flex */
      align-items: center;
      justify-content: center;
    }
    
    .btn-add {
      background-color: #4CAF50;
    }
    
    .btn-import {
      background-color: #2d7ef7;
    }
    
    .action-btn:hover {
      filter: brightness(1.08);
    }


  </style>
</head>
<body>

<header>
  <button onclick="location.href='home.html'" title="Vai alla home">
    <img src="logo.jpg" alt="Logo Vita" />
  </button>
</header>

<h1>I tuoi Mazzi</h1>
<div id="listaMazzi">
  <!-- Lista mazzi caricata via JS -->
</div>

<div class="action-bar">
  <button id="aggiungiMazzoBtn" class="action-btn btn-add">
    Aggiungi nuovo mazzo
  </button>

  <button id="importaMazzoBtn" class="action-btn btn-import">
    Importa mazzo (.json)
  </button>
</div>




  <!-- MODAL IMPORT MAZZO -->
  <div id="importModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:9999; padding:20px; box-sizing:border-box;">
    <div style="max-width:700px; margin:60px auto; background:rgba(255,255,255,0.98); border-radius:12px; padding:18px; box-shadow:0 0 20px rgba(0,0,0,0.3);">
      <h2 style="margin-top:0;">Importa mazzo</h2>
  
      <div id="dropZone"
        style="border:2px dashed #888; border-radius:10px; padding:22px; text-align:center; background:#fafafa; cursor:pointer;">
        Trascina qui un file <b>.json</b><br>
        oppure clicca per sceglierlo
      </div>
  
      <input id="fileInput" type="file" accept="application/json,.json" style="display:none;" />
  
      <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:14px;">
        <label style="display:flex; gap:8px; align-items:center;">
          Nome mazzo (se vuoto usa il nome del file):
          <input id="importNomeMazzo" type="text" placeholder="es: Starter Deck Starlight"
                 style="padding:8px; min-width:260px;">
        </label>
      </div>
  
      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:18px; flex-wrap:wrap;">
        <button id="btnChiudiImport" style="padding:10px 14px; cursor:pointer;">Annulla</button>
        <button id="btnConfermaImport" style="padding:10px 14px; cursor:pointer; background:#2d7ef7; color:#fff; border:none; border-radius:8px;">
          Importa
        </button>
      </div>
  
      <div id="importMsg" style="margin-top:10px; color:#444;"></div>
    </div>
  </div>


  
<script>
  let __cardsPromise = null;
  
  async function loadAllCards() {
    if (__cardsPromise) return __cardsPromise;
  
    __cardsPromise = (async () => {
      try {
        const manifestRes = await fetch("cards/manifest.json");
        if (!manifestRes.ok) throw new Error("manifest non trovato");
        const manifest = await manifestRes.json();
  
        const lists = await Promise.all(
          (manifest.sets || []).map(async (s) => {
            const r = await fetch(s.file);
            if (!r.ok) throw new Error(`Errore fetch set: ${s.file} (${r.status})`);
            const arr = await r.json();
            return Array.isArray(arr) ? arr : [];
          })
        );
  
        // Unisce tutti i set in un unico array
        return lists.flat();
      } catch (e) {
        // fallback compatibilitÃ : prova il vecchio cards.json
        const r = await fetch("cards.json");
        if (!r.ok) throw e;
        const data = await r.json();
        return Array.isArray(data) ? data : [];
      }
    })();
  
    return __cardsPromise;
  }

  
  // Carica mazzi da localStorage, mostra ordinati per nome
  async function caricaMazzi() {
    const container = document.getElementById('listaMazzi');
    container.innerHTML = '';
    const cards = await loadAllCards();

    
    const idToCarta = {};
    cards.forEach(c => idToCarta[c.ID] = c);
    
    const keys = Object.keys(localStorage)
      .filter(k => k.startsWith('mazzo_'))
      .sort();

    if (keys.length === 0) {
      container.textContent = 'Nessun mazzo salvato.';
      return;
    }

    keys.forEach(key => {
      const nomeMazzo = key.slice(6); // togli 'mazzo_'
      let mazzo;
      try {
        mazzo = JSON.parse(localStorage.getItem(key));
      } catch {
        mazzo = null;
      }
      if (!mazzo) return;


          const carteConInfo = [];
          for (const id in mazzo) {
            const carta = idToCarta[id];
            if (!carta) continue;
            carteConInfo.push({ nomeCarta: carta["NOME CARTA"], qty: mazzo[id], costo: carta.COSTO || 0 });
          }
          carteConInfo.sort((a,b) => a.costo - b.costo);
          const totaleCarte = carteConInfo.reduce((sum, c) => sum + c.qty, 0);
          const fuoriRange = totaleCarte < 50 || totaleCarte > 70;


          // Crea markup
          const divMazzo = document.createElement('div');
          divMazzo.className = 'mazzo-item';

          const infoDiv = document.createElement('div');
          infoDiv.className = 'mazzo-info';

          const titolo = document.createElement('strong');
          titolo.textContent = nomeMazzo;
          infoDiv.appendChild(titolo);
          if (fuoriRange) {
            titolo.style.color = 'crimson';
            titolo.textContent += ` âš ï¸ (${totaleCarte} carte)`;
            titolo.title = 'âš ï¸ Il mazzo deve contenere tra 50 e 70 carte';
          } else {
            titolo.textContent += ` (${totaleCarte} carte)`;
          }

          const cardsText = carteConInfo.map(c => `${c.nomeCarta} (${c.qty})`).join(', ');
          const cardsDiv = document.createElement('div');
          cardsDiv.className = 'mazzo-cards';
          cardsDiv.textContent = cardsText || '(Mazzo vuoto)';
          infoDiv.appendChild(cardsDiv);

          divMazzo.appendChild(infoDiv);

          // Buttons container
          const buttonsDiv = document.createElement('div');
          buttonsDiv.className = 'mazzo-buttons';


          // Modifica
          const btnModifica = document.createElement('button');
          btnModifica.textContent = 'Modifica';
          btnModifica.onclick = () => {
            location.href = `modifica_mazzo.html?mazzo=${encodeURIComponent(nomeMazzo)}`;
          };
          buttonsDiv.appendChild(btnModifica);

          // Rinomina
          const btnRinomina = document.createElement('button');
          btnRinomina.textContent = 'Rinomina';
          btnRinomina.onclick = () => {
            const nuovoNome = prompt(`Rinomina il mazzo "${nomeMazzo}" in:`, nomeMazzo);
            if (!nuovoNome) return;
            const nomePulito = nuovoNome.trim();
            if (nomePulito === '') {
              alert('Nome non valido.');
              return;
            }
            const nuovaChiave = 'mazzo_' + nomePulito;
            if (localStorage.getItem(nuovaChiave)) {
              alert('Esiste giÃ  un mazzo con questo nome.');
              return;
            }
            const dati = localStorage.getItem(key);
            localStorage.setItem(nuovaChiave, dati);
            localStorage.removeItem(key);
            caricaMazzi();
          };
          buttonsDiv.appendChild(btnRinomina);


          // Elimina
          const btnElimina = document.createElement('button');
          btnElimina.textContent = 'Elimina';
          btnElimina.onclick = () => {
            if (confirm(`Eliminare il mazzo "${nomeMazzo}"?`)) {
              localStorage.removeItem(key);
              caricaMazzi();
            }
          };
          buttonsDiv.appendChild(btnElimina);

          divMazzo.appendChild(buttonsDiv);
          container.appendChild(divMazzo);
        });
  }

  // Aggiungi nuovo mazzo (prompt per nome, crea vuoto)
  document.getElementById('aggiungiMazzoBtn').onclick = () => {
    let nome = prompt('Inserisci il nome del nuovo mazzo:');
    if (!nome) return;
    nome = nome.trim();
    if (nome === '') {
      alert('Nome mazzo non valido');
      return;
    }
    const key = 'mazzo_' + nome;
    if (localStorage.getItem(key)) {
      alert('Un mazzo con questo nome esiste giÃ ');
      return;
    }
    localStorage.setItem(key, JSON.stringify({}));
    caricaMazzi();
  };

  // Carica mazzi a pagina pronta
  window.onload = caricaMazzi;

  let __importFile = null;
  
  // apre/chiude modal
  function openImportModal() {
    document.getElementById("importModal").style.display = "block";
    document.getElementById("importMsg").textContent = "";
    document.getElementById("importNomeMazzo").value = "";
    __importFile = null;
  }
  function closeImportModal() {
    document.getElementById("importModal").style.display = "none";
    __importFile = null;
  }
  
  // legge file e lo mette in memoria
  async function handleFile(file) {
    const msg = document.getElementById("importMsg");
    msg.style.color = "#444";
    msg.textContent = "";
  
    if (!file) return;
  
    if (!file.name.toLowerCase().endsWith(".json")) {
      msg.style.color = "crimson";
      msg.textContent = "Seleziona un file .json";
      return;
    }
  
    __importFile = file;
    msg.textContent = `File selezionato: ${file.name}`;
  }
  
  // normalizza nome mazzo per key localStorage
  function pulisciNomeMazzo(nome) {
    return (nome || "").trim();
  }
  
  // accetta due formati:
  // A) { "carte": { "1": 2, "4": 3 } , ... }
  // B) { "1": 2, "4": 3 }  (mazzo â€œsempliceâ€)
  function estraiMappaCarte(jsonObj) {
    if (!jsonObj || typeof jsonObj !== "object") return null;
  
    // formato A
    if (jsonObj.carte && typeof jsonObj.carte === "object" && !Array.isArray(jsonObj.carte)) {
      return jsonObj.carte;
    }
  
    // formato B (oggetto semplice di id->qty)
    // accetto solo se le chiavi sembrano numeri e i valori sono numerici
    const keys = Object.keys(jsonObj);
    if (keys.length === 0) return {}; // mazzo vuoto ok
    const ok = keys.every(k => !isNaN(Number(k)) && (typeof jsonObj[k] === "number" || typeof jsonObj[k] === "string"));
    return ok ? jsonObj : null;
  }
  
  function contaTotaleCarte(deckMap) {
    return Object.values(deckMap || {}).reduce((s, v) => s + (Number(v) || 0), 0);
  }
  
  // importa nel localStorage come mazzo_<nome>
  async function importaMazzoDaFile() {
    const msg = document.getElementById("importMsg");
  
    if (!__importFile) {
      msg.style.color = "crimson";
      msg.textContent = "Nessun file selezionato.";
      return;
    }
  
    let json;
    try {
      const text = await __importFile.text();
      json = JSON.parse(text);
    } catch (e) {
      msg.style.color = "crimson";
      msg.textContent = "File non valido: impossibile leggere JSON.";
      return;
    }
  
    const deckMap = estraiMappaCarte(json);
    if (!deckMap) {
      msg.style.color = "crimson";
      msg.textContent = "Formato non riconosciuto. Deve essere {carte:{ID:qty}} oppure {ID:qty}.";
      return;
    }
  
    // Nome mazzo: input oppure nome file senza estensione oppure json.nome/titolo
    const nomeInput = pulisciNomeMazzo(document.getElementById("importNomeMazzo").value);
    const baseFile = __importFile.name.replace(/\.json$/i, "");
    const nomeDaJson = pulisciNomeMazzo(json.nome || json.titolo || "");
    const nomeMazzo = nomeInput || nomeDaJson || baseFile;
  
    if (!nomeMazzo) {
      msg.style.color = "crimson";
      msg.textContent = "Nome mazzo non valido.";
      return;
    }
  
    const key = "mazzo_" + nomeMazzo;
  
    if (localStorage.getItem(key)) {
      // se esiste giÃ , chiedi conferma sovrascrittura
      if (!confirm(`Esiste giÃ  un mazzo chiamato "${nomeMazzo}". Vuoi sovrascriverlo?`)) {
        msg.style.color = "#444";
        msg.textContent = "Import annullato.";
        return;
      }
    }
  
    // pulizia: conserva solo id->qty numerici >0
    const clean = {};
    for (const id in deckMap) {
      const q = Number(deckMap[id]) || 0;
      if (q > 0) clean[String(Number(id))] = q;
    }
  
    localStorage.setItem(key, JSON.stringify(clean));
  
    const tot = contaTotaleCarte(clean);
    msg.style.color = "#2e7d32";
    msg.textContent = `âœ… Importato "${nomeMazzo}" (${tot} carte)`;
  
    // aggiorna lista e chiudi dopo un attimo
    caricaMazzi();
    setTimeout(closeImportModal, 700);
  }
  
  // wiring UI
  document.getElementById("importaMazzoBtn").onclick = openImportModal;
  document.getElementById("btnChiudiImport").onclick = closeImportModal;
  document.getElementById("btnConfermaImport").onclick = importaMazzoDaFile;
  
  // chiudi cliccando sullo sfondo scuro
  document.getElementById("importModal").addEventListener("click", (e) => {
    if (e.target.id === "importModal") closeImportModal();
  });
  
  // drop zone + click per file picker
  const dropZone = document.getElementById("dropZone");
  const fileInput = document.getElementById("fileInput");
  
  dropZone.addEventListener("click", () => fileInput.click());
  
  fileInput.addEventListener("change", () => {
    const file = fileInput.files && fileInput.files[0];
    handleFile(file);
  });
  
  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.style.background = "#f0f6ff";
  });
  
  dropZone.addEventListener("dragleave", () => {
    dropZone.style.background = "#fafafa";
  });
  
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.style.background = "#fafafa";
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    handleFile(file);
  });

</script>

</body>
</html>
